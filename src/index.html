<!DOCTYPE html> 
<html> 
<head>
  <title>Enrich: empowering audio files</title>
  <!--Using annyang voice control library-->
  <script src="//cdnjs.cloudflare.com/ajax/libs/annyang/1.1.0/annyang.min.js"></script>
  <!--Using the aadsm Javascript ID3 tag reader -->
  <script src="//rawgit.com/aadsm/JavaScript-ID3-Reader/master/dist/id3-minimized.js"></script>
  <!--Using file reader js library-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
</head>

<body>
  <div>
    <!-- Create an html5 audio player -->
    <audio id='myBook' controls ></audio> 
    <!--User uploads the input mp3-->
    <input type='file' id="file" 
    onchange='handleFiles(this.files)' /> 
    <button onclick="slowerPlayback()" type="button">slower</button>
    <button onclick="fasterPlayback()" type="button">faster</button>
    <br> 
  </div>
  
  <dl>
        <dt>Enrich Frame Text</dt>
        <dd id="enrichData"></dd>
  </dl>

  <noscript>If you don't allow Javascript then you cannot enjoy the internet</noscript>
  <script>
    // we will later store the enrichments in this var
    var enrichments = "";
    // load in the mp3 file and create a handle. 
    function handleFiles(files){ 
        var myURL = window.URL || window.webkitURL
        // console.log('winurl='+ myURL);
        var file = window.URL.createObjectURL(files[0]); 
        myBook = document.getElementById('myBook');
        myBook.src = file; 
        myBook.load();
        myBook.play();
        enrich(document.getElementById("file"));
    }
    
    // grab the enrichments from the id3 tag in the file
    function enrich(elem) {
        if (elem.id === "file"){
            var url = elem.files[0].urn ||elem.files[0].name;
            ID3.loadTags(url, function() {
                var tags = ID3.getAllTags(url);
                enrichments = tags.TXXX.data;
            }, {tags: ["TXXX"], dataReader: FileAPIReader(elem.files[0])});
        }
    }
    
    
   
    // setting up some constants
    maxPlaybackRate = 1.75;
    minPlaybackRate = 0.5;


    // basic functions of the player that we will want to access
    function getPlaySpeed(){ 
        alert(myBook.playbackRate)
    } 

    // adjust playback speeds based on users input
    function fasterPlayback(){
      if (myBook.playbackRate < maxPlaybackRate){
        myBook.playbackRate=myBook.playbackRate + 0.25;
      }
    }
    function slowerPlayback(){ 
      if (myBook.playbackRate > minPlaybackRate){
          myBook.playbackRate=myBook.playbackRate - 0.25;
      }
    } 

    function pause(){
      myBook.pause();
    }

    function play(){
      myBook.play();
    }


    // voice commands
    "use strict";
    if (annyang) {
      var getPlaySpeed = function() {
        alert(myBook.playbackRate)
      };

      var fasterPlayback = function() {
        if (myBook.playbackRate < maxPlaybackRate){
           myBook.playbackRate=myBook.playbackRate + 0.25;
         }
      };

      var slowerPlayback = function() {
        if (myBook.playbackRate > minPlaybackRate){
           myBook.playbackRate = myBook.playbackRate - 0.25;
         }
      };

      var pause = function() {
        myBook.pause();
      };

      var play = function() {
        myBook.play();
      };


      // Let's define some commands
      var commands = {
          'wait':   pause,
          'pause':   pause,
          'stop':   pause,
          'go ahead':  play,
          'play':   play,
          'continue': play,
          'resume':   play,
          'faster':   fasterPlayback,
          'slower':   slowerPlayback,
          'current speed':   getPlaySpeed,
      };

        

        // Add our commands to annyang
        annyang.addCommands(commands);

        // Start listening.
        annyang.start();
    }
    else {
      alert('annyang failed')
    }
  </script> 

</body> 
</html>