<!DOCTYPE html> 
<html> 
<head>
  <title>Enrich: empowering audio files</title>
  <!--Using annyang voice control library-->
  <script src="//cdnjs.cloudflare.com/ajax/libs/annyang/1.1.0/annyang.min.js"></script>
  <!--Using the aadsm Javascript ID3 tag reader -->
  <script src="//rawgit.com/aadsm/JavaScript-ID3-Reader/master/dist/id3-minimized.js"></script>
  <!--Using file reader js library-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
</head>

<body>
  <div>
    <!-- Create an html5 audio player -->
    <audio id='myBook' controls ></audio> 
    <!--User uploads the input mp3-->
    <input type='file' id="file" 
    onchange='handleFiles(this.files)' /> 
    <button onclick="slowerPlayback()" type="button">slower</button>
    <button onclick="fasterPlayback()" type="button">faster</button>
    <br> 
  </div>
  
  <dl>
        <dt>Enrich Frame Text</dt>
        <dt id="enrichData">OLD</dt>
  </dl>

  <noscript>If you don't allow Javascript then you cannot enjoy the internet</noscript>
  <script>
    // enrichments will contain the raw tag string that is encoded into the file
    var enrichments = "";

    // we will tokenize enrichments and store them as contents and events
    var contents = [];
    var events = [];

    // load in the mp3 file and create a handle. 
    function handleFiles(files){ 
        var myURL = window.URL || window.webkitURL
        // console.log('winurl='+ myURL);
        var file = window.URL.createObjectURL(files[0]); 
        myBook = document.getElementById('myBook');
        myBook.src = file; 
        myBook.load();
        myBook.play();
        getEnrichments(document.getElementById("file"));
        
    }
    
    // grab the enrichments from the id3 tag in the file
    function getEnrichments(elem) {
        if (elem.id === "file"){
            var url = elem.files[0].urn ||elem.files[0].name;
            ID3.loadTags(url, function() {
                var tags = ID3.getAllTags(url);
                enrichments = tags.TXXX.data;
                enrich();
                
            }, {tags: ["TXXX"], dataReader: FileAPIReader(elem.files[0])});
        }
    }

    function enrich() {
    	document.getElementById("enrichData").innerHTML = enrichments;
    	tokenize();
    }

    // this function will tokenize the enrichments string and place the tokens
    // in the appropriate lists
    function tokenize() {
    	var i; // start index for token
    	var j = 0; // end index for token
    	var token = "";
    	for (i = 0; (i < enrichments.length - 1) && (j < enrichments.length - 1); i = j + 1) {
    		// shift j to the next character (usually to the next open parens)
    		j++;

    		// get the index for the end of the token 
    		while ((enrichments.charAt(j) != ')') && (j < enrichments.length)) { j++; }

    		// create the token object and add it to the contents list
    		createContent(enrichments.substring(i+1, j));
    	}
    }

    // this function takes in a token that needs to be added to the content list, creates the 
    // content object, and adds the object to the list of contents
    function createContent(token) {
    	// the structure of content object will be:
    	// {type: contentType, time: contentTime, payload: contentPayload}
    	var contentType = token.charAt(0);

    	var minutes = parseInt(token.substring(3, token.indexOf(":")));
    	var seconds = parseInt(token.substring(token.indexOf(":")+1, token.lastIndexOf(",")));
    	var contentTime = (minutes * 60) + seconds;
    	// alert(minutes + ":" + seconds + " = " + contentTime + " seconds.");

    	var contentPayload = token.substring(token.indexOf("$")+1, token.lastIndexOf("$"));

    	// create and add this content token to the list of contents
    	contents[contents.length] = {type: contentType, time: contentTime, payload: contentPayload};
    }
    
   
    // setting up some constants
    maxPlaybackRate = 1.75;
    minPlaybackRate = 0.5;


    // basic functions of the player that we will want to access
    function getPlaySpeed(){ 
        alert(myBook.playbackRate)
    } 

    // adjust playback speeds based on users input
    function fasterPlayback(){
      if (myBook.playbackRate < maxPlaybackRate){
        myBook.playbackRate=myBook.playbackRate + 0.25;
      }
    }
    function slowerPlayback(){ 
      if (myBook.playbackRate > minPlaybackRate){
          myBook.playbackRate=myBook.playbackRate - 0.25;
      }
    } 

    function pause(){
      myBook.pause();
    }

    function play(){
      myBook.play();
    }


    // voice commands
    "use strict";
    if (annyang) {
      var getPlaySpeed = function() {
        alert(myBook.playbackRate)
      };

      var fasterPlayback = function() {
        if (myBook.playbackRate < maxPlaybackRate){
           myBook.playbackRate=myBook.playbackRate + 0.25;
         }
      };

      var slowerPlayback = function() {
        if (myBook.playbackRate > minPlaybackRate){
           myBook.playbackRate = myBook.playbackRate - 0.25;
         }
      };

      var pause = function() {
        myBook.pause();
      };

      var play = function() {
        myBook.play();
      };


      // Let's define some commands
      var commands = {
          'wait':   pause,
          'pause':   pause,
          'stop':   pause,
          'go ahead':  play,
          'play':   play,
          'continue': play,
          'resume':   play,
          'faster':   fasterPlayback,
          'slower':   slowerPlayback,
          'current speed':   getPlaySpeed,
      };

        

        // Add our commands to annyang
        annyang.addCommands(commands);

        // Start listening.
        annyang.start();
    }
    else {
      alert('annyang failed')
    }
  </script> 

</body> 
</html>